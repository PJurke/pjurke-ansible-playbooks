---
- name: Install essential security packages
  apt:
    name:
      - fail2ban
      - ufw
    state: present
  tags: [security, packages]

# --- 1. FIREWALL (UFW) ---

- name: Set UFW policy to ‘deny’ (incoming)
  community.general.ufw:
    policy: deny
    direction: incoming
  tags: [security, ufw]

- name: Set UFW policy to ‘allow’ (outgoing)
  community.general.ufw:
    policy: allow
    direction: outgoing
  tags: [security, ufw]

- name: Allow new SSH port in UFW
  community.general.ufw:
    rule: allow
    port: "{{ security_ssh_port | string }}"
    proto: tcp
    comment: 'SSH Custom Port'
  tags: [security, ufw]

- name: Allow web server ports (HTTP/HTTPS) in UFW
  community.general.ufw:
    rule: allow
    port: "{{ item | string }}"
    proto: tcp
  loop: "{{ security_allowed_tcp_ports }}"
  tags: [security, ufw]

- name: Enable UFW
  community.general.ufw:
    state: enabled
  tags: [security, ufw]

# --- 2. SSH ---

- name: Ensure SSH login group exists
  group:
    name: sshlogin
    state: present

- name: Add admin user to SSH group
  user:
    name: "{{ admin_user_name }}"
    groups: sshlogin
    append: yes

- name: Deploy hardened SSH configuration (sshd_config)
  template:
    src: sshd_config.j2
    dest: /etc/ssh/sshd_config
    owner: root
    group: root
    mode: '0644'
    validate: 'sshd -t -f %s'
  notify: Restart SSH
  tags: [security, ssh]

# --- 3. FAIL2BAN ---

- name: Copy Fail2Ban configuration (jail.local)
  template:
    src: jail.local.j2
    dest: /etc/fail2ban/jail.local
    owner: root
    group: root
    mode: '0644'
  notify: Restart Fail2Ban
  tags: [security, fail2ban]

- name: Start and activate the Fail2Ban service
  service:
    name: fail2ban
    state: started
    enabled: yes
  tags: [security, fail2ban]