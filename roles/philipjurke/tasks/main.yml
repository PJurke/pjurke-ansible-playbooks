---
# --- PHASE 1: User & System Setup ---

- name: Create app user '{{ philipjurke_user }}'
  user:
    name: "{{ philipjurke_user }}"
    shell: /bin/bash
    create_home: yes
    home: "{{ philipjurke_home }}"
    state: present

- name: Reload user facts (for UID access)
  getent:
    database: passwd
    key: "{{ philipjurke_user }}"

- name: Enable lingering (for rootless containers)
  command: "loginctl enable-linger {{ philipjurke_user }}"
  register: linger_result
  changed_when: "'Created' in linger_result.stderr"

# --- PHASE 2: Traefik Routing (Root Context) ---

- name: Deploy Traefik Router Config (Dynamic File)
  template:
    src: traefik-router.yml.j2
    dest: "{{ traefik_dynamic_conf_dir_host }}/philipjurke.yml"
    owner: root
    group: root
    mode: '0644'
  become: yes
  # No 'become_user', the root will own this file

- name: Allow PhilipJurke Host Port in UFW
  community.general.ufw:
    rule: allow
    port: "{{ philipjurke_host_port | string }}"
    proto: tcp
    comment: "Allow Traffic from Podman Network to PhilipJurke"
  become: yes

# --- PHASE 3: App Deployment (User Context) ---

- name: Log in to GHCR.io
  command: >
    podman login ghcr.io
    --username "{{ ghcr_username }}"
    --password "{{ ghcr_token }}"
  become: yes
  become_user: "{{ philipjurke_user }}"
  no_log: yes
  when: ghcr_token is defined

- name: Create systemd directory for Quadlets
  file:
    path: "{{ philipjurke_home }}/.config/containers/systemd"
    state: directory
    owner: "{{ philipjurke_user }}"
    group: "{{ philipjurke_user }}"
    mode: '0755'
    recurse: yes

- name: Deploy Quadlet (.container) file
  template:
    src: philipjurke.container.j2
    dest: "{{ philipjurke_home }}/.config/containers/systemd/philipjurke.container"
    owner: "{{ philipjurke_user }}"
    mode: '0644'
  become: yes
  become_user: "{{ philipjurke_user }}"
  notify: Restart PhilipJurke

- name: System Daemon Reload (User Scope)
  systemd:
    daemon_reload: yes
    scope: user
  become: yes
  become_user: "{{ philipjurke_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ ansible_facts.getent_passwd[philipjurke_user][1] }}"

# --- PHASE 4: CI/CD Access ---

- name: Authorize GitHub Actions Deploy Key (Restricted)
  ansible.posix.authorized_key:
    user: "{{ philipjurke_user }}"
    state: present
    key: "{{ github_deploy_public_key }}" 
    # Security feature: Update-only
    key_options: 'command="/usr/bin/podman auto-update",no-port-forwarding,no-x11-forwarding,no-agent-forwarding,no-pty'
    comment: "GitHub Actions Auto-Deploy"
  when: github_deploy_public_key is defined